// Generated by CoffeeScript 1.6.2
var BarrierMap, EnemyRobot, ItemQueue, PlayerRobot, R, Robot,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

R = Config.R;

/*
    store bullet objects
*/


ItemQueue = (function() {
  function ItemQueue(collection, max) {
    this.collection = collection != null ? collection : [];
    this.max = max != null ? max : -1;
  }

  ItemQueue.prototype.enqueue = function(item) {
    if (this.max !== -1 && this.max <= this.collection.length) {
      return false;
    } else {
      this.collection.push(item);
      return true;
    }
  };

  ItemQueue.prototype.dequeue = function(count) {
    var i, ret, _i;

    if (count == null) {
      count = 1;
    }
    ret = [];
    for (i = _i = 0; 0 <= count ? _i < count : _i > count; i = 0 <= count ? ++_i : --_i) {
      ret.push(this.collection.shift());
    }
    return ret;
  };

  ItemQueue.prototype.empty = function() {
    return this.collection.length === 0;
  };

  ItemQueue.prototype.size = function() {
    return this.collection.length;
  };

  return ItemQueue;

})();

BarrierMap = (function(_super) {
  __extends(BarrierMap, _super);

  function BarrierMap(robot) {
    this.robot = robot;
  }

  BarrierMap.prototype.get = function(key) {
    var ret;

    ret = this[key];
    delete this[key];
    this.robot.onResetBarrier(key);
    return ret;
  };

  BarrierMap.prototype.isset = function(key) {
    if (this[key] != null) {
      return true;
    } else {
      return false;
    }
  };

  return BarrierMap;

})(Object);

Robot = (function(_super) {
  __extends(Robot, _super);

  Robot.MAX_HP = 4;

  function Robot(width, height, parentNode) {
    this.onAnimateComplete = __bind(this.onAnimateComplete, this);
    var plate, pos;

    Robot.__super__.constructor.call(this, width, height);
    this.name = "robot";
    this.game = Game.instance;
    this.animated = false;
    this.hp = Robot.MAX_HP;
    this.bltQueue = new ItemQueue([], 5);
    this.wideBltQueue = new ItemQueue([], 5);
    this.dualBltQueue = new ItemQueue([], 5);
    this.barrierMap = new BarrierMap(this);
    this.map = Map.instance;
    this.plateState = 0;
    parentNode.addChild(this);
    plate = this.map.getPlate(0, 0);
    this.prevPlate = this.currentPlate = plate;
    pos = plate.getAbsolutePos();
    this.moveTo(pos.x, pos.y);
  }

  Robot.prototype.onViewUpdate = function(views) {};

  Robot.prototype.onHpReduce = function(views) {};

  Robot.prototype.onKeyInput = function(input) {};

  Robot.prototype.onAnimateComplete = function() {
    return this.animated = false;
  };

  Robot.prototype.onSetBarrier = function(bulletType) {};

  Robot.prototype.onResetBarrier = function(bulletType) {};

  Robot.prototype.onCmdComplete = function(id, ret) {
    var msgbox;

    msgbox = this.scene.views.msgbox;
    switch (id) {
      case RobotInstruction.MOVE:
        this.prevPlate.onRobotAway(this);
        this.currentPlate.onRobotRide(this);
        if (ret !== false) {
          msgbox.print(R.String.move(this.name, ret.x + 1, ret.y + 1));
          return this.animated = true;
        } else {
          return msgbox.print(R.String.CANNOTMOVE);
        }
        break;
      case RobotInstruction.SHOT:
        if (ret !== false) {
          return msgbox.print(R.String.shot(this.name));
        } else {
          return msgbox.print(R.String.CANNOTSHOT);
        }
        break;
      case RobotInstruction.PICKUP:
        if (ret !== false) {
          return msgbox.print(R.String.pickup(this.name));
        } else {
          return msgbox.print(R.String.CANNOTPICKUP);
        }
    }
  };

  Robot.prototype.moveToPlate = function(plate) {
    var pos;

    this.prevPlate.onRobotAway(this);
    this.pravState = this.currentPlate;
    this.currentPlate = plate;
    this.currentPlate.onRobotRide(this);
    pos = plate.getAbsolutePos();
    return this.moveTo(pos.x, pos.y);
  };

  Robot.prototype.getDirect = function() {
    switch (this.frame) {
      case 0:
        return Direct.RIGHT;
      case 1:
        return Direct.UP;
      case 2:
        return Direct.LEFT;
      case 3:
        return Direct.DOWN;
      case 4:
        return Direct.UP | Direct.RIGHT;
      case 5:
        return Direct.DOWN | Direct.RIGHT;
      case 6:
        return Direct.UP | Direct.LEFT;
      case 7:
        return Direct.DOWN | Direct.LEFT;
    }
  };

  Robot.prototype.damege = function() {
    this.hp -= 1;
    return this.onHpReduce();
  };

  Robot.prototype.update = function() {
    this.x = Math.round(this.x);
    this.y = Math.round(this.y);
    this.onKeyInput(this.game.input);
    return true;
  };

  return Robot;

})(Sprite);

PlayerRobot = (function(_super) {
  __extends(PlayerRobot, _super);

  PlayerRobot.WIDTH = 64;

  PlayerRobot.HEIGHT = 74;

  PlayerRobot.UPDATE_FRAME = 10;

  function PlayerRobot(parentNode) {
    PlayerRobot.__super__.constructor.call(this, PlayerRobot.WIDTH, PlayerRobot.HEIGHT, parentNode);
    this.name = R.String.PLAYER;
    this.image = this.game.assets[R.CHAR.PLAYER];
    this.plateState = Plate.STATE_PLAYER;
  }

  PlayerRobot.prototype.onSetBarrier = function(bulletType) {
    var statusBox;

    statusBox = this.scene.views.footer.statusBox;
    switch (bulletType) {
      case BulletType.NORMAL:
        return statusBox.statusNormalBarrier.set();
      case BulletType.WIDE:
        return statusBox.statusWideBarrier.set();
      case BulletType.DUAL:
        return statusBox.statusDualBarrier.set();
    }
  };

  PlayerRobot.prototype.onResetBarrier = function(bulletType) {
    var statusBox;

    statusBox = this.scene.views.footer.statusBox;
    switch (bulletType) {
      case BulletType.NORMAL:
        return statusBox.statusNormalBarrier.reset();
      case BulletType.WIDE:
        return statusBox.statusWideBarrier.reset();
      case BulletType.DUAL:
        return statusBox.statusDualBarrier.reset();
    }
  };

  PlayerRobot.prototype.onCmdComplete = function(id, ret) {
    var effect, plate, statusBox;

    PlayerRobot.__super__.onCmdComplete.call(this, id, ret);
    statusBox = this.scene.views.footer.statusBox;
    switch (id) {
      case RobotInstruction.MOVE:
        if (Math.floor(Math.random() * 10.) === 1) {
          plate = this.map.getPlateRandom();
          return plate.setSpot(Spot.getRandomType());
        }
        break;
      case RobotInstruction.SHOT:
        if (ret !== false) {
          effect = new ShotEffect(this.x, this.y);
          this.scene.addChild(effect);
          if (ret instanceof WideBullet) {
            return statusBox.wideRemain.decrement();
          } else if (ret instanceof NormalBullet) {
            return statusBox.normalRemain.decrement();
          } else if (ret instanceof DualBullet) {
            return statusBox.dualRemain.decrement();
          }
        }
        break;
      case RobotInstruction.PICKUP:
        if (ret !== false) {
          if (ret instanceof WideBullet) {
            return statusBox.wideRemain.increment();
          } else if (ret instanceof NormalBullet) {
            return statusBox.normalRemain.increment();
          } else if (ret instanceof DualBullet) {
            return statusBox.dualRemain.increment();
          }
        }
    }
  };

  PlayerRobot.prototype.onHpReduce = function(views) {
    var hpBar, scene;

    scene = Game.instance.scene;
    hpBar = scene.views.playerHpBar;
    return hpBar.reduce();
  };

  return PlayerRobot;

})(Robot);

EnemyRobot = (function(_super) {
  __extends(EnemyRobot, _super);

  EnemyRobot.SIZE = 64;

  EnemyRobot.UPDATE_FRAME = 10;

  function EnemyRobot(parentNode) {
    EnemyRobot.__super__.constructor.call(this, EnemyRobot.SIZE, EnemyRobot.SIZE, parentNode);
    this.name = R.String.ENEMY;
    this.image = this.game.assets[R.CHAR.ENEMY];
    this.plateState = Plate.STATE_ENEMY;
  }

  EnemyRobot.prototype.onHpReduce = function(views) {
    var hpBar;

    hpBar = this.scene.views.enemyHpBar;
    return hpBar.reduce();
  };

  return EnemyRobot;

})(Robot);
