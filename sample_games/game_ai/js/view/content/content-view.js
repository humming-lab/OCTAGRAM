// Generated by CoffeeScript 1.6.3
var Map, Plate, R,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

R = Config.R;

Plate = (function(_super) {
  var Body, EnergyOverlay, Overlay;

  __extends(Plate, _super);

  Plate.MAX_ENERGY = 90;

  Plate.HEIGHT = 74;

  Plate.WIDTH = 64;

  Plate.STATE_NORMAL = 0;

  Plate.STATE_PLAYER = 1;

  Plate.STATE_ENEMY = 2;

  Plate.STATE_SELECTED = 3;

  Body = (function(_super1) {
    __extends(Body, _super1);

    function Body() {
      Body.__super__.constructor.call(this, Plate.WIDTH, Plate.HEIGHT);
      this.image = Game.instance.assets[R.BACKGROUND_IMAGE.PLATE];
    }

    return Body;

  })(Sprite);

  EnergyOverlay = (function(_super1) {
    __extends(EnergyOverlay, _super1);

    function EnergyOverlay() {
      EnergyOverlay.__super__.constructor.call(this, Plate.WIDTH, Plate.HEIGHT);
      this.image = Game.instance.assets[R.BACKGROUND_IMAGE.PLATE_ENERGY];
      this.opacity = 0;
    }

    return EnergyOverlay;

  })(Sprite);

  Overlay = (function(_super1) {
    __extends(Overlay, _super1);

    function Overlay() {
      Overlay.__super__.constructor.call(this, Plate.WIDTH, Plate.HEIGHT);
      this.image = Game.instance.assets[R.BACKGROUND_IMAGE.PLATE_OVERLAY];
    }

    return Overlay;

  })(Sprite);

  function Plate(x, y, ix, iy) {
    var _this = this;
    this.ix = ix;
    this.iy = iy;
    Plate.__super__.constructor.call(this, Plate.WIDTH, Plate.HEIGHT);
    this.x = x;
    this.y = y;
    this.lock = false;
    this.energy = Plate.MAX_ENERGY;
    this.pravState = Plate.STATE_NORMAL;
    this.body = new Body();
    this.overlay = new Overlay();
    this.energyOverlay = new EnergyOverlay();
    this.addChild(this.body);
    this.addChild(this.energyOverlay);
    this.addChild(this.overlay);
    this.addEventListener('away', function(evt) {
      return _this.onRobotAway(evt.params.robot);
    });
    this.addEventListener('ride', function(evt) {
      return _this.onRobotRide(evt.params.robot);
    });
    Object.defineProperties(this, this.properties);
  }

  Plate.prototype.properties = {
    pos: {
      get: function() {
        return new Point(toi(Math.ceil(this.iy / 2)) + this.ix, this.iy);
      }
    }
  };

  Plate.prototype.setState = function(state) {
    this.pravState = this.overlay.frame;
    this.overlay.frame = state;
    if (state === Plate.STATE_PLAYER || state === Plate.STATE_ENEMY) {
      return this.lock = true;
    } else {
      return this.lock = false;
    }
  };

  Plate.prototype.setBody = function() {
    if (this.energy <= 0) {
      return this.energyOverlay.opacity = 1;
    } else {
      return this.energyOverlay.opacity = (Plate.MAX_ENERGY - this.energy) / Plate.MAX_ENERGY;
    }
  };

  Plate.prototype.setPrevState = function() {
    return this.setState(this.prevState);
  };

  Plate.prototype.stealEnergy = function(value) {
    if (this.energy - value >= 0) {
      this.energy -= value;
    } else {
      value = this.energy;
    }
    this.setBody();
    return value;
  };

  Plate.prototype.saveEnergy = function(value) {
    if (this.energy + value <= Plate.MAX_ENERGY) {
      this.energy += value;
    } else {
      this.energy = Plate.MAX_ENERGY;
    }
    return this.setBody();
  };

  Plate.prototype.getAbsolutePos = function() {
    var i, offsetX, offsetY;
    i = this.parentNode;
    offsetX = offsetY = 0;
    while (i != null) {
      offsetX += i.x;
      offsetY += i.y;
      i = i.parentNode;
    }
    return new Point(this.x + offsetX, this.y + offsetY);
  };

  Plate.prototype.onRobotAway = function(robot) {
    return this.setState(Plate.STATE_NORMAL);
  };

  Plate.prototype.onRobotRide = function(robot) {
    return this.setState(robot.plateState);
  };

  Plate.prototype.update = function() {
    if (Plate.MAX_ENERGY > this.energy && this.age % 90 === 0) {
      return this.saveEnergy(Plate.MAX_ENERGY / 9);
    }
  };

  Plate.prototype.reset = function() {
    return this.saveEnergy(Plate.MAX_ENERGY);
  };

  return Plate;

})(ViewGroup);

Map = (function(_super) {
  __extends(Map, _super);

  Map.WIDTH = 9;

  Map.HEIGHT = 7;

  Map.OFFSET_SIZE = 5;

  Map.UNIT_HEIGHT = Plate.HEIGHT;

  Map.UNIT_WIDTH = Plate.WIDTH;

  function Map(x, y) {
    var list, offset, plate, tx, ty, _i, _j, _ref, _ref1;
    if (Map.instance != null) {
      return Map.instance;
    }
    Map.__super__.constructor.apply(this, arguments);
    Map.instance = this;
    this.plateMatrix = [];
    offset = 64 / 4;
    for (ty = _i = 0, _ref = Map.HEIGHT; 0 <= _ref ? _i < _ref : _i > _ref; ty = 0 <= _ref ? ++_i : --_i) {
      list = [];
      for (tx = _j = 0, _ref1 = Map.WIDTH; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; tx = 0 <= _ref1 ? ++_j : --_j) {
        if (ty % 2 === 0) {
          plate = new Plate(tx * Map.UNIT_WIDTH, (ty * Map.UNIT_HEIGHT) - ty * offset, tx, ty);
        } else {
          plate = new Plate(tx * Map.UNIT_WIDTH + Map.UNIT_HEIGHT / 2, (ty * Map.UNIT_HEIGHT) - ty * offset, tx, ty);
        }
        list.push(plate);
        this.addChild(plate);
      }
      this.plateMatrix.push(list);
    }
    this.x = x;
    this.y = y;
    this.width = Map.WIDTH * Map.UNIT_WIDTH;
    this.height = (Map.HEIGHT - 1) * (Map.UNIT_HEIGHT - offset) + Map.UNIT_HEIGHT + 8;
  }

  Map.prototype.initEvent = function(world) {};

  Map.prototype.getPlate = function(x, y) {
    if ((0 <= x && x < Map.WIDTH) && (0 <= y && y < Map.HEIGHT)) {
      return this.plateMatrix[y][x];
    }
    return null;
  };

  Map.prototype.getPlateRandom = function() {
    return this.plateMatrix[Math.floor(Math.random() * Map.HEIGHT)][Math.floor(Math.random() * Map.WIDTH)];
  };

  Map.prototype.eachPlate = function(plate, direct, func) {
    var i, ret, _results;
    if (direct == null) {
      direct = Direct.RIGHT;
    }
    ret = plate;
    i = 0;
    _results = [];
    while (ret != null) {
      func(ret, i);
      ret = this.getTargetPoision(ret, direct);
      _results.push(i++);
    }
    return _results;
  };

  Map.prototype.eachSurroundingPlate = function(plate, func) {
    var _this = this;
    return Direct.each(function(direct) {
      var target;
      target = _this.getTargetPoision(plate, direct);
      if (target != null) {
        return func(target, direct);
      }
    });
  };

  Map.prototype.isExistObject = function(plate, direct, lenght) {
    var i, ret, _i;
    if (direct == null) {
      direct = Direct.RIGHT;
    }
    ret = plate;
    for (i = _i = 0; 0 <= lenght ? _i < lenght : _i > lenght; i = 0 <= lenght ? ++_i : --_i) {
      ret = this.getTargetPoision(ret, direct);
      if (ret === null) {
        break;
      } else if (ret.lock === true) {
        return true;
      }
    }
    return false;
  };

  Map.prototype.getTargetPoision = function(plate, direct) {
    var offset;
    if (direct == null) {
      direct = Direct.RIGHT;
    }
    if (direct === Direct.RIGHT) {
      if (this.plateMatrix[plate.iy].length > plate.ix + 1) {
        return this.plateMatrix[plate.iy][plate.ix + 1];
      } else {
        return null;
      }
    } else if (direct === Direct.LEFT) {
      if (plate.ix > 0) {
        return this.plateMatrix[plate.iy][plate.ix - 1];
      } else {
        return null;
      }
    }
    if ((direct & Direct.RIGHT) !== 0 && (direct & Direct.UP) !== 0) {
      offset = plate.iy % 2 === 0 ? 0 : 1;
      if (offset + plate.ix < Map.WIDTH && plate.iy > 0) {
        return this.plateMatrix[plate.iy - 1][offset + plate.ix];
      } else {
        return null;
      }
    } else if ((direct & Direct.RIGHT) !== 0 && (direct & Direct.DOWN) !== 0) {
      offset = plate.iy % 2 === 0 ? 0 : 1;
      if (offset + plate.ix < Map.WIDTH && plate.iy + 1 < Map.HEIGHT) {
        return this.plateMatrix[plate.iy + 1][offset + plate.ix];
      } else {
        return null;
      }
    } else if ((direct & Direct.LEFT) !== 0 && (direct & Direct.UP) !== 0) {
      offset = plate.iy % 2 === 0 ? -1 : 0;
      if (offset + plate.ix >= 0 && plate.iy > 0) {
        return this.plateMatrix[plate.iy - 1][offset + plate.ix];
      } else {
        return null;
      }
    } else if ((direct & Direct.LEFT) !== 0 && (direct & Direct.DOWN) !== 0) {
      offset = plate.iy % 2 === 0 ? -1 : 0;
      if (offset + plate.ix >= 0 && plate.iy + 1 < Map.HEIGHT) {
        return this.plateMatrix[plate.iy + 1][offset + plate.ix];
      } else {
        return null;
      }
    }
    return null;
  };

  Map.prototype.update = function() {
    var tx, ty, _i, _ref, _results;
    _results = [];
    for (ty = _i = 0, _ref = Map.HEIGHT; 0 <= _ref ? _i < _ref : _i > _ref; ty = 0 <= _ref ? ++_i : --_i) {
      _results.push((function() {
        var _j, _ref1, _results1;
        _results1 = [];
        for (tx = _j = 0, _ref1 = Map.WIDTH; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; tx = 0 <= _ref1 ? ++_j : --_j) {
          _results1.push(this.plateMatrix[ty][tx].update());
        }
        return _results1;
      }).call(this));
    }
    return _results;
  };

  Map.prototype.reset = function() {
    var tx, ty, _i, _ref, _results;
    _results = [];
    for (ty = _i = 0, _ref = Map.HEIGHT; 0 <= _ref ? _i < _ref : _i > _ref; ty = 0 <= _ref ? ++_i : --_i) {
      _results.push((function() {
        var _j, _ref1, _results1;
        _results1 = [];
        for (tx = _j = 0, _ref1 = Map.WIDTH; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; tx = 0 <= _ref1 ? ++_j : --_j) {
          _results1.push(this.plateMatrix[ty][tx].reset());
        }
        return _results1;
      }).call(this));
    }
    return _results;
  };

  return Map;

})(ViewGroup);
